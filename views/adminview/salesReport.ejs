<%- include('./layouts/adminHeader') %>




    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Sales Report</h2>
            </div>
        </div>
        <div class="card">
            <header class="card-header">
                <div class="row align-items-center">
                    <div class=" col-md-8 mb-lg-0 mb-15" style="display: flex;">
                        <div class="col-lg-4 col-6" style="margin-right: 10px;">
                            <span style="display: flex;">From: &nbsp;</span>
                            <input type="date" min="<%= firstOrder %>" max="<%= lastOrder %>" class=" form-control"
                                name="" id="fromDateInput" />
                        </div>
                        <div class="col-lg-4 col-6">
                            <span style="display: flex;">To: &nbsp;</span>
                            <input type="date" class="form-control" name="" id="toDateInput" pattern="\d{2}/\d{2}/\d{4}"
                                min="<%= firstOrder %>" max="<%= lastOrder %>" />
                        </div>


                    </div>
                    <div class=" col-md-4 ms-auto text-md-end">

                        <!-- <a class="btn btn-primary print ms-2" href="#"><i class="icon material-icons md-print"></i></a> -->
                    </div>
                </div>
            </header>
            <!-- card-header end// -->
            <div class="card-body">

                <!-- row // -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th width="17%">OrderId</th>
                                        <th width="30%">Delivery Address</th>
                                        <th width="30%">Products</th>
                                        <th width="10%">Amount</th>
                                        <th width="10%">Total Products</th>
                                        <th width="10%">Order Date</th>
                                        <th width="10%">Payment</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <% orders.forEach(order=> { %>

                                        <tr>
                                            <td>
                                                #<%=order.orderId %>
                                            </td>
                                            <td>
                                                <%=order.delivery_address %>
                                            </td>


                                            <td>
                                                <% order.items.forEach(item=> { %>
                                                    <%= item.productId.productName %> <br>
                                                        <% }); %>
                                            </td>

                                            <td>
                                                <%=order.total_amount %>
                                            </td>
                                            <td>
                                                <%= order.totalProductsCount %>
                                            </td>

                                            <td>
                                                <%=order.date %>
                                            </td>
                                            <td>
                                                <%=order.payment %>
                                            </td>
                                        </tr>
                                        <% }); %>

                                            <td colspan="8">
                                                <article class="float-end">
                                                    <dl class="dlist">
                                                        <dt>Product Sold:</dt>
                                                        <dd id="totalQty">
                                                            <%= totalQty %>
                                                        </dd>
                                                    </dl>
                                                    <dl class="dlist">
                                                        <dt>Total Revenue:</dt>
                                                        <dd id="totalAmount">>â‚¹<%= totalAmount %>
                                                        </dd>
                                                    </dl>


                                                </article>
                                            </td>
                                            </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- table-responsive// -->
                    </div>
                    <!-- col// -->
                    <!-- <div class="col-lg-1"></div>
                    <div class="col-lg-4">
                        <div class="box shadow-sm bg-light">
                            <h6 class="mb-15">Payment info</h6>
                            <p>
                                <img src="assets/imgs/card-brands/2.png" class="border" height="20" /> Master Card ****
                                **** 4768 <br />
                                Business name: Grand Market LLC <br />
                                Phone: +1 (800) 555-154-52
                            </p>
                        </div>
                        <div class="h-25 pt-4">
                            <div class="mb-3">
                                <label>Notes</label>
                                <textarea class="form-control" name="notes" id="notes"
                                    placeholder="Type some note"></textarea>
                            </div>
                            <button class="btn btn-primary">Save note</button>
                        </div>
                    </div> -->
                    <!-- col// -->
                </div>
            </div>
            <!-- card-body end// -->
        </div>
        <!-- card end// -->
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fromDateInput = document.querySelector('#fromDateInput');
            const toDateInput = document.querySelector('#toDateInput');

            const fetchData = async () => {
                try {
                    const response = await axios.get('/admin/salesReport', {
                        params: {
                            startDate: fromDateInput.value,
                            endDate: toDateInput.value
                        }, headers: {
                            'Accept': 'application/json', // Explicitly request JSON response
                        },
                    });
                    // console.log('startDate::', fromDateInput.value, 'endDate::', toDateInput.value);
                    // console.log('data::', response.data);

                    updateSalesData(response.data);
                } catch (error) {
                    console.error('Error fetching sales data:', error);
                }
            };

            fromDateInput.addEventListener('change', fetchData);
            toDateInput.addEventListener('change', fetchData);

            const updateSalesData = (salesData) => {
                console.log('Received sales data:', salesData);

                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';
                if (!Array.isArray(salesData)) {
                    console.error('Invalid sales data format. Expected an array.');
                    return;
                }
                if (salesData.length === 0) {
                    console.log('No sales data available for the selected date range.');
                    return;
                }
                salesData.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>#${order.orderId}</td>
            <td>${order.delivery_address}</td>
            <td>${order.items.map(item => item.productId.productName).join('<br>')}</td>
            <td>${order.total_amount}</td>
            <td>${order.totalProductsCount}</td>
            <td>${order.date}</td>
            <td>${order.payment}</td>
        `;
                    tbody.appendChild(row);
                });

                // Update totalQty and totalAmount
                const totalQtyElement = document.querySelector('#totalQty');
                const totalAmountElement = document.querySelector('#totalAmount');
                totalQtyElement.textContent = salesData.reduce((sum, order) => sum + order.totalProductsCount, 0);
                totalAmountElement.textContent = salesData.reduce((sum, order) => sum + order.total_amount, 0);
            };
        });
    </script>



    <%- include('./layouts/adminFooter') %>